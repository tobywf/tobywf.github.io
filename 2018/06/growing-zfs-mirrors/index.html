<!DOCTYPE html>
<html lang="en">
<head>
  <title>Growing ZFS mirrors - tobywf</title>
  <meta charset="utf-8" />
  <meta name="author" content="Toby Fleming" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:300,300italic,700|Source+Code+Pro:400,700|Montserrat:400" />
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://tobywf.com/theme/main.css" />
  <link rel="icon" href="https://tobywf.com/theme/favicon.png" />
</head>
<body>
  <div class="wrapper">
    <nav>
      <ul>
<!-- breadcrumbs start -->
<li><a href="https://tobywf.com/" id="siteicon"><img src="https://tobywf.com/theme/favicon.svg" alt="Site Icon" /></a></li>
<li class="breadcrumb"><a href="https://tobywf.com/2018/">&#x27;18</a></li>
<li class="breadcrumb"><a href="https://tobywf.com/2018/06/">Jun</a></li>
<li class="last"><a href="https://tobywf.com/resume/" class="cap">résumé</a></li>
<!-- breadcrumbs end -->
      </ul>
    </nav>
<!-- content start -->
<header class="post-head">
  <h1>Growing <span class="caps">ZFS</span>&nbsp;mirrors</h1>
  <div class="infoline">
    <span class="fa fa-calendar"></span> <span class="date">30 Jun &#x27;18</span>
  </div>
</header>
<article>
<p>I have long contended that for small, home <span class="caps">NAS</span> systems, <a href="https://tobywf.com/2016/01/home-nas-build-guide/">mirrors are the way to go</a>. You don&#8217;t have to calculate how much parity you need, similarly, the backup size is also obvious. It costs less upfront, you only need two disks. And because you only need two disks, you can get the biggest disks you can afford, which usually have excellent <span class="caps">GB</span>/cent cost&nbsp;ratios.</p>
<p>Finally, you can grow mirrors! As long as your storage needs don&#8217;t outstrip storage space growth, you can grow your mirrors very economically. Case in point, I was running a <span class="caps">2TB</span> mirror which was getting close to 80% full. I was able to buy <span class="caps">8TB</span> disks <a href="https://tobywf.com/2018/06/shucking-8tb-wd-easystores/">very cheaply</a>, and grow my mirror to <span class="caps">8TB</span>.</p>
<p>First things first, <strong>don&#8217;t be an idiot</strong>, this guide is how to modify storage. Triple check everything, and make sure you have backups. This guide also assumes the disks are blank, i.e.&nbsp;unformatted.</p>
<h2 id="step-1-install-new-drive">Step 1: Install new&nbsp;drive</h2>
<p>I had no spare bays/<span class="caps">SATA</span> connections, but if you did, you could potentially do this in a more safer way by adding the new disks to a mirror to create a 3 or 4-way mirror, and then pulling the old disks&nbsp;out.</p>
<p>I had to do it more riskily by degrading the mirror. First, I powered down the <span class="caps">NAS</span>. Then I replaced one of the old disks in the mirror with a new one and powered up again. First, let&#8217;s check the right disk was&nbsp;pulled:</p>
<div class="codehilite"><pre><span></span><span class="gp">$</span> zpool status pool
<span class="go">  pool: pool</span>
<span class="go"> state: DEGRADED</span>
<span class="go">status: One or more devices could not be opened.  Sufficient replicas exist for</span>
<span class="go">    the pool to continue functioning in a degraded state.</span>
<span class="go">action: Attach the missing device and online it using &#39;zpool online&#39;.</span>
<span class="go">   see: http://illumos.org/msg/ZFS-8000-2Q</span>
<span class="go">  scan: scrub repaired 0 in 0 days 02:49:09 with 0 errors on Sun May 13 02:49:10 2018</span>
<span class="go">config:</span>

<span class="go">    NAME                                            STATE     READ WRITE CKSUM</span>
<span class="go">    pool                                            DEGRADED     0     0     0</span>
<span class="go">      mirror-0                                      DEGRADED     0     0     0</span>
<span class="go">        11300205822825511459                        UNAVAIL      0     0     0  was /dev/gptid/d8bea02b-178c-11e8-9b2e-28924a390410</span>
<span class="go">        gptid/d9ae78ea-178c-11e8-9b2e-28924a390410  ONLINE       0     0     0</span>

<span class="go">errors: No known data errors</span>
</pre></div>


<p>As expected, the mirror is degraded. So, now to figure out which drive is the new&nbsp;drive:</p>
<div class="codehilite"><pre><span></span><span class="gp">$</span> ls -1 /dev/ada*
<span class="go">/dev/ada0</span>
<span class="go">/dev/ada1</span>
<span class="go">/dev/ada1p1</span>
<span class="go">/dev/ada1p2</span>
<span class="go">/dev/ada2</span>
<span class="go">/dev/ada2p1</span>
<span class="go">/dev/ada3</span>
<span class="go">/dev/ada3p1</span>
</pre></div>


<p>What&#8217;s going on? Well, drives are mounted in <code>/dev</code> and receive a name, e.g. <code>ada1</code>. The partitions are also mounted as <code>/dev/ada1p1</code> and <code>/dev/ada1p2</code>. So it&#8217;s already pretty obvious that the new drive is <code>ada0</code>.</p>
<p>Just to check, we&#8217;ll look at the labels and partitions. <span class="caps">BSD</span> labels drives with UUIDs, since the name assigned in <code>/dev</code> is basically random, and drives could get reassigned on&nbsp;start-up.</p>
<div class="codehilite"><pre><span></span>$ glabel status
                                      Name  Status  Components
gptid/23edea4a-1742-11e8-b551-28924a390410     N/A  da0p1
gptid/d9ae78ea-178c-11e8-9b2e-28924a390410     N/A  ada1p2
gptid/d98b522f-178c-11e8-9b2e-28924a390410     N/A  ada1p1

$ gpart <span class="nv">show</span>
<span class="o">=</span>&gt;      <span class="m">40</span>  <span class="m">15663024</span>  da0  GPT  <span class="o">(</span><span class="m">7</span>.5G<span class="o">)</span>
        <span class="m">40</span>      <span class="m">1024</span>    <span class="m">1</span>  bios-boot  <span class="o">(</span>512K<span class="o">)</span>
      <span class="m">1064</span>  <span class="m">15661992</span>    <span class="m">2</span>  freebsd-zfs  <span class="o">(</span><span class="m">7</span>.5G<span class="o">)</span>
  <span class="m">15663056</span>         <span class="m">8</span>       - free -  <span class="o">(</span><span class="m">4</span>.0K<span class="o">)</span>

<span class="o">=</span>&gt;        <span class="m">40</span>  <span class="m">3907029088</span>  ada1  GPT  <span class="o">(</span><span class="m">1</span>.8T<span class="o">)</span>
          <span class="m">40</span>          <span class="m">88</span>        - free -  <span class="o">(</span>44K<span class="o">)</span>
         <span class="m">128</span>     <span class="m">4194304</span>     <span class="m">1</span>  freebsd-swap  <span class="o">(</span><span class="m">2</span>.0G<span class="o">)</span>
     <span class="m">4194432</span>  <span class="m">3902834688</span>     <span class="m">2</span>  freebsd-zfs  <span class="o">(</span><span class="m">1</span>.8T<span class="o">)</span>
  <span class="m">3907029120</span>           <span class="m">8</span>        - free -  <span class="o">(</span><span class="m">4</span>.0K<span class="o">)</span>

$ glabel list <span class="p">|</span> grep ada0
$
</pre></div>


<p>Ignore <code>da0</code>, it is the <span class="caps">OS</span> <span class="caps">USB</span> disk. The blank disk is <code>ada0</code>, it has no labels or partition&nbsp;map.</p>
<h2 id="step-2-create-gpt-partition-map">Step 2: Create <span class="caps">GPT</span> partition&nbsp;map</h2>
<p>Create the partition map on the new&nbsp;disk:</p>
<div class="codehilite"><pre><span></span><span class="gp">$</span> sudo gpart create -s gpt ada0
<span class="go">ada0 created</span>
</pre></div>


<p>Now re-create partitions similar to the other disk in the mirror. My distro FreeNAS allocates a bit of swap space on all drives, so we want to replicate that. Get the parameters for <code>gpart add</code> from <code>gpart list</code>, <code>-t</code> is the type, <code>-b</code> is the the starting offset, <code>-i</code> is the index, and <code>-s</code> is the size. I don&#8217;t know why FreeNAS sets a starting offset for the swap partition, but&nbsp;whatever.</p>
<div class="codehilite"><pre><span></span><span class="gp">$</span> gpart show ada0
<span class="go">=&gt;         40  15628053088  ada0  GPT  (7.3T)</span>
<span class="go">           40  15628053088        - free -  (7.3T)</span>

<span class="gp">$</span> gpart show ada1
<span class="go">=&gt;        40  3907029088  ada1  GPT  (1.8T)</span>
<span class="go">          40          88        - free -  (44K)</span>
<span class="go">         128     4194304     1  freebsd-swap  (2.0G)</span>
<span class="go">     4194432  3902834688     2  freebsd-zfs  (1.8T)</span>
<span class="go">  3907029120           8        - free -  (4.0K)</span>

<span class="gp">$</span> gpart list ada1
<span class="go">[...]</span>
<span class="go">scheme: GPT</span>
<span class="go">Providers:</span>
<span class="go">1. Name: ada1p1</span>
<span class="go">   Mediasize: 2147483648 (2.0G)</span>
<span class="go">   [...]</span>
<span class="go">   type: freebsd-swap</span>
<span class="go">   index: 1</span>
<span class="go">   end: 4194431</span>
<span class="go">   start: 128</span>
<span class="go">2. Name: ada1p2</span>
<span class="go">   Mediasize: 1998251360256 (1.8T)</span>
<span class="go">   [...]</span>
<span class="go">   type: freebsd-zfs</span>
<span class="go">   index: 2</span>
<span class="go">   end: 3907029119</span>
<span class="go">   start: 4194432</span>
<span class="go">Consumers:</span>
<span class="go">1. Name: ada1</span>
<span class="go">   Mediasize: 2000398934016 (1.8T)</span>
<span class="go">   Sectorsize: 512</span>
<span class="go">   Stripesize: 4096</span>
<span class="go">   Stripeoffset: 0</span>
<span class="go">   Mode: r1w1e3</span>

<span class="gp">$</span> sudo gpart add -t freebsd-swap -b <span class="m">128</span> -i <span class="m">1</span> -s 2G ada0
<span class="go">ada0p1 added</span>
<span class="gp">$</span> gpart show ada0
<span class="go">=&gt;         40  15628053088  ada0  GPT  (7.3T)</span>
<span class="go">           40           88        - free -  (44K)</span>
<span class="go">          128      4194304     1  freebsd-swap  (2.0G)</span>
<span class="go">      4194432  15623858696        - free -  (7.3T)</span>

<span class="gp">$</span> gpart show ada1
<span class="go">=&gt;        40  3907029088  ada1  GPT  (1.8T)</span>
<span class="go">          40          88        - free -  (44K)</span>
<span class="go">         128     4194304     1  freebsd-swap  (2.0G)</span>
<span class="go">     4194432  3902834688     2  freebsd-zfs  (1.8T)</span>
<span class="go">  3907029120           8        - free -  (4.0K)</span>

<span class="gp">$</span> sudo gpart add -t freebsd-zfs -i <span class="m">2</span> ada0
<span class="go">ada0p2 added</span>
<span class="gp">$</span> gpart show ada0
<span class="go">=&gt;         40  15628053088  ada0  GPT  (7.3T)</span>
<span class="go">           40           88        - free -  (44K)</span>
<span class="go">          128      4194304     1  freebsd-swap  (2.0G)</span>
<span class="go">      4194432  15623858688     2  freebsd-zfs  (7.3T)</span>
<span class="go">  15628053120            8        - free -  (4.0K)</span>

<span class="gp">$</span> gpart show ada1
<span class="go">=&gt;        40  3907029088  ada1  GPT  (1.8T)</span>
<span class="go">          40          88        - free -  (44K)</span>
<span class="go">         128     4194304     1  freebsd-swap  (2.0G)</span>
<span class="go">     4194432  3902834688     2  freebsd-zfs  (1.8T)</span>
<span class="go">  3907029120           8        - free -  (4.0K)</span>
</pre></div>


<h2 id="step-3-add-the-new-diskpartition-to-the-mirror">Step 3: Add the new disk/partition to the&nbsp;mirror</h2>
<p>Now that the disk has a label/<span class="caps">UUID</span>, it&#8217;s time to stop referring to it as <code>ada0</code> where&nbsp;possible.</p>
<div class="codehilite"><pre><span></span><span class="gp">$</span> glabel status
<span class="go">                                      Name  Status  Components</span>
<span class="go">gptid/23edea4a-1742-11e8-b551-28924a390410     N/A  da0p1</span>
<span class="go">gptid/d9ae78ea-178c-11e8-9b2e-28924a390410     N/A  ada1p2</span>
<span class="go">gptid/fa78eb2a-178f-11e8-99e9-28924a390410     N/A  ada2p1</span>
<span class="go">gptid/fb1b40fa-178f-11e8-99e9-28924a390410     N/A  ada3p1</span>
<span class="go">gptid/d98b522f-178c-11e8-9b2e-28924a390410     N/A  ada1p1</span>
<span class="go">gptid/e5ebdfcc-726e-11e8-a5a9-28924a390410     N/A  ada0p1</span>
<span class="go">gptid/03d44ba4-726f-11e8-a5a9-28924a390410     N/A  ada0p2</span>

<span class="gp">$</span> gpart list ada0 <span class="p">|</span> grep rawuuid
<span class="go">   rawuuid: e5ebdfcc-726e-11e8-a5a9-28924a390410</span>
<span class="go">   rawuuid: 03d44ba4-726f-11e8-a5a9-28924a390410</span>

<span class="gp">$</span> zpool status pool
<span class="go">  pool: pool</span>
<span class="go"> state: DEGRADED</span>
<span class="go">status: One or more devices could not be opened.  Sufficient replicas exist for</span>
<span class="go">    the pool to continue functioning in a degraded state.</span>
<span class="go">action: Attach the missing device and online it using &#39;zpool online&#39;.</span>
<span class="go">   see: http://illumos.org/msg/ZFS-8000-2Q</span>
<span class="go">  scan: scrub repaired 0 in 0 days 02:49:09 with 0 errors on Sun May 13 02:49:10 2018</span>
<span class="go">config:</span>

<span class="go">    NAME                                            STATE     READ WRITE CKSUM</span>
<span class="go">    pool                                            DEGRADED     0     0     0</span>
<span class="go">      mirror-0                                      DEGRADED     0     0     0</span>
<span class="go">        11300205822825511459                        UNAVAIL      0     0     0  was /dev/gptid/d8bea02b-178c-11e8-9b2e-28924a390410</span>
<span class="go">        gptid/d9ae78ea-178c-11e8-9b2e-28924a390410  ONLINE       0     0     0</span>

<span class="go">errors: No known data errors</span>
</pre></div>


<p>In this case, the label is <code>03d44ba4-726f-11e8-a5a9-28924a390410</code> for the second partition, and I want to resilver from the online disk, <code>d9ae78ea-178c-11e8-9b2e-28924a390410</code>:</p>
<div class="codehilite"><pre><span></span><span class="gp">$</span> sudo zpool attach pool <span class="se">\</span>
  /dev/gptid/d9ae78ea-178c-11e8-9b2e-28924a390410 <span class="se">\</span>
  /dev/gptid/03d44ba4-726f-11e8-a5a9-28924a390410
<span class="gp">$</span> zpool status pool
<span class="go">  pool: pool</span>
<span class="go"> state: DEGRADED</span>
<span class="go">status: One or more devices is currently being resilvered.  The pool will</span>
<span class="go">    continue to function, possibly in a degraded state.</span>
<span class="go">action: Wait for the resilver to complete.</span>
<span class="go">  scan: resilver in progress since Sun Jun 17 13:54:32 2018</span>
<span class="go">    862G scanned at 464M/s, 3.13G issued at 31.4M/s, 1.70T total</span>
<span class="go">    3.12G resilvered, 0.18% done, 0 days 15:43:42 to go</span>
<span class="go">config:</span>

<span class="go">    NAME                                            STATE     READ WRITE CKSUM</span>
<span class="go">    pool                                            DEGRADED     0     0     0</span>
<span class="go">      mirror-0                                      DEGRADED     0     0     0</span>
<span class="go">        11300205822825511459                        UNAVAIL      0     0     0  was /dev/gptid/d8bea02b-178c-11e8-9b2e-28924a390410</span>
<span class="go">        gptid/d9ae78ea-178c-11e8-9b2e-28924a390410  ONLINE       0     0     0</span>
<span class="go">        gptid/03d44ba4-726f-11e8-a5a9-28924a390410  ONLINE       0     0     0  (resilvering)</span>

<span class="go">errors: No known data errors</span>
</pre></div>


<h2 id="step-4-wait">Step 4:&nbsp;Wait</h2>
<p>Resilvering takes&nbsp;time.</p>
<h2 id="step-5-repeat-with-the-other-drive-in-the-mirror">Step 5: Repeat with the other drive in the&nbsp;mirror</h2>
<p>And please make sure you pull the right&nbsp;drive!</p>
<div class="codehilite"><pre><span></span><span class="gp">$</span> zpool status pool
<span class="go">  pool: pool</span>
<span class="go"> state: DEGRADED</span>
<span class="go">status: One or more devices is currently being resilvered.  The pool will</span>
<span class="go">    continue to function, possibly in a degraded state.</span>
<span class="go">action: Wait for the resilver to complete.</span>
<span class="go">  scan: resilver in progress since Sun Jun 17 18:10:33 2018</span>
<span class="go">    865G scanned at 183M/s, 331M issued at 4.67M/s, 1.70T total</span>
<span class="go">    323M resilvered, 0.02% done, no estimated completion time</span>
<span class="go">config:</span>

<span class="go">    NAME                                            STATE     READ WRITE CKSUM</span>
<span class="go">    pool                                            DEGRADED     0     0     0</span>
<span class="go">      mirror-0                                      DEGRADED     0     0     0</span>
<span class="go">        11300205822825511459                        UNAVAIL      0     0     0  was /dev/gptid/d8bea02b-178c-11e8-9b2e-28924a390410</span>
<span class="go">        6780713986779558112                         UNAVAIL      0     0     0  was /dev/gptid/d9ae78ea-178c-11e8-9b2e-28924a390410</span>
<span class="go">        gptid/03d44ba4-726f-11e8-a5a9-28924a390410  ONLINE       0     0     0</span>
<span class="go">        gptid/1d2d3246-7294-11e8-85fd-28924a390410  ONLINE       0     0     0  (resilvering)</span>

<span class="go">errors: No known data errors</span>
<span class="gp">$</span> zpool status pool
<span class="go">  pool: pool</span>
<span class="go"> state: DEGRADED</span>
<span class="go">status: One or more devices could not be opened.  Sufficient replicas exist for</span>
<span class="go">    the pool to continue functioning in a degraded state.</span>
<span class="go">action: Attach the missing device and online it using &#39;zpool online&#39;.</span>
<span class="go">   see: http://illumos.org/msg/ZFS-8000-2Q</span>
<span class="go">  scan: resilvered 1.70T in 0 days 02:58:23 with 0 errors on Sun Jun 17 21:08:56 2018</span>
<span class="go">config:</span>

<span class="go">    NAME                                            STATE     READ WRITE CKSUM</span>
<span class="go">    pool                                            DEGRADED     0     0     0</span>
<span class="go">      mirror-0                                      DEGRADED     0     0     0</span>
<span class="go">        11300205822825511459                        UNAVAIL      0     0     0  was /dev/gptid/d8bea02b-178c-11e8-9b2e-28924a390410</span>
<span class="go">        6780713986779558112                         UNAVAIL      0     0     0  was /dev/gptid/d9ae78ea-178c-11e8-9b2e-28924a390410</span>
<span class="go">        gptid/03d44ba4-726f-11e8-a5a9-28924a390410  ONLINE       0     0     0</span>
<span class="go">        gptid/1d2d3246-7294-11e8-85fd-28924a390410  ONLINE       0     0     0</span>

<span class="go">errors: No known data errors</span>
</pre></div>


<h2 id="step-6-detach-old-disks-and-watch-the-mirror-grow">Step 6: Detach old disks and watch the mirror&nbsp;grow</h2>
<div class="codehilite"><pre><span></span><span class="gp">$</span> sudo zpool detach pool <span class="m">11300205822825511459</span>
<span class="gp">$</span> zpool status pool <span class="p">|</span> grep <span class="s1">&#39;state:&#39;</span>
<span class="go"> state: DEGRADED</span>
<span class="gp">$</span> sudo zpool detach pool <span class="m">6780713986779558112</span>
<span class="gp">$</span> zpool status pool
<span class="go">  pool: pool</span>
<span class="go"> state: ONLINE</span>
<span class="go">  scan: resilvered 1.70T in 0 days 02:58:23 with 0 errors on Sun Jun 17 21:08:56 2018</span>
<span class="go">config:</span>

<span class="go">    NAME                                            STATE     READ WRITE CKSUM</span>
<span class="go">    pool                                            ONLINE       0     0     0</span>
<span class="go">      mirror-0                                      ONLINE       0     0     0</span>
<span class="go">        gptid/03d44ba4-726f-11e8-a5a9-28924a390410  ONLINE       0     0     0</span>
<span class="go">        gptid/1d2d3246-7294-11e8-85fd-28924a390410  ONLINE       0     0     0</span>

<span class="go">errors: No known data errors</span>
<span class="gp">$</span> zpool list -o name,size
<span class="go">NAME           SIZE</span>
<span class="go">pool          7.27T</span>
<span class="go">freenas-boot  7.44G</span>
</pre></div>


<p>Job&nbsp;done.</p>
</article>
<section>
  <p><span class="fa fa-tags"></span> <a href="https://tobywf.com/tag/zfs/">ZFS</a>, <a href="https://tobywf.com/tag/freenas/">FreeNAS</a>, <a href="https://tobywf.com/tag/nas/">NAS</a>, <a href="https://tobywf.com/tag/storage/">storage</a>, <a href="https://tobywf.com/tag/bsd/">BSD</a></p>
  <a href="https://tobywf.com/2018/06/shucking-8tb-wd-easystores/" class="older"><span class="fa fa-chevron-circle-left"></span> Older</a>
</section>
<!-- content end -->
    <footer>
      <hr />
      <p class="center">
        <a href="https://github.com/tobywf" class="fa-stack fa-lg">
          <span class="fa fa-github fa-stack-2x"></span>
        </a>
        <a href="https://uk.linkedin.com/in/tobywf" class="fa-stack fa-lg">
          <span class="fa fa-circle fa-stack-2x"></span>
          <span class="fa fa-linkedin fa-stack-1x fa-inverse"></span>
        </a>
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" class="fa-stack fa-lg" style="font-size: 120%;">
          <span class="fa fa-creative-commons fa-stack-2x"></span>
        </a>
      </p>
      <p>
        <span class="fa fa-child fa-fw"></span>Born naked, helpless, and unable to fend for himself, Toby eventually overcame these handicaps to become a code craftsman, tinkerer, and musician. He posts his ramblings here. Toby is currently in Seattle.
      </p>
      <p>
        <span class="fa fa-copyright fa-fw"></span><span class="date cap">mmxii&ndash;mmxviii</span> <span class="name cap">Toby Fleming</span>
      </p>
      <p>
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
          <span class="fa fa-creative-commons fa-fw"></span>BY-NC-ND 4.0
        </a>
      </p>
    </footer>
  </div>
</body>
</html>